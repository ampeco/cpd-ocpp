{"version":3,"sources":["../src/connection.js"],"names":["debug","Connection","socket","req","requests","url","ip","connection","remoteAddress","headers","protocol","on","msg","onMessage","err","console","info","message","messageType","messageId","commandNameOrPayload","commandPayload","errorDetails","JSON","parse","Error","CommandModel","commandRequest","responseData","responseObj","sendError","onRequest","createResponse","sendMessage","request","Array","isArray","length","responseCallback","rejectCallback","command","error","self","commandValues","resolve","reject","messageToSend","onResponse","onRejectResponse","commandName","getCommandName","code","details","readyState","OPEN","send","setTimeout","payload","response","reason"],"mappings":"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","file":"connection.js","sourcesContent":["import uuid from 'uuid/v4';\nimport Websocket from 'ws';\nimport debugFn from 'debug';\nimport commands from './commands';\nimport {CALL_MESSAGE, CALLERROR_MESSAGE, CALLRESULT_MESSAGE, DEBUG_LIBNAME, SOCKET_TIMEOUT} from './constants';\nimport {getObjectValues} from './helpers';\nimport OCPPError, {ERROR_FORMATIONVIOLATION, ERROR_INTERNALERROR} from './ocppError';\n\nconst debug = debugFn(DEBUG_LIBNAME);\n\nexport class Connection {\n  constructor(socket, req = null) {\n    this.socket = socket;\n    this.req = req;\n    this.requests = {};\n\n    if (req) {\n      this.url = req && req.url;\n      const ip = req && ((req.connection && req.connection.remoteAddress) || req.headers['x-forwarded-for']);\n\n      debug(`New connection from \"${ip}\", protocol \"${socket.protocol}\", url \"${this.url}\"`);\n    } else {\n      this.url = 'SERVER';\n      debug(`New connection to server`);\n    }\n\n    socket.on('message', (msg) => this.onMessage(msg));\n\n    socket.on('error', (err) => {\n      console.info(err);\n    });\n  }\n\n  async onMessage (message) {\n    let messageType, messageId, commandNameOrPayload, commandPayload, errorDetails;\n\n    try {\n      [messageType, messageId, commandNameOrPayload, commandPayload, errorDetails] = JSON.parse(message);\n    } catch (err) {\n      throw new Error(`Failed to parse message: \"${message}\", ${err.message}`);\n    }\n\n    switch (messageType) {\n      case CALL_MESSAGE:\n        // request\n        debug(`>> ${this.url}: ${message}`);\n\n        const CommandModel = commands[commandNameOrPayload];\n        if (!CommandModel) {\n          throw new Error(`Unknown command ${commandNameOrPayload}`);\n        }\n        let commandRequest, responseData, responseObj;\n        try {\n          commandRequest = new CommandModel(commandPayload);\n        } catch (err) {\n          // send error if payload didn't pass the validation\n          return await this.sendError(messageId, new OCPPError(ERROR_FORMATIONVIOLATION, err.message));\n        }\n\n        try {\n          responseData = await this.onRequest(commandRequest);\n          responseObj = commandRequest.createResponse(responseData);\n        } catch (err) {\n          return await this.sendError(messageId, err);\n        }\n\n        // try {\n        await this.sendMessage(messageId, responseObj, CALLRESULT_MESSAGE);\n        // } catch (err) {\n        //   await this.sendError(messageId, err);\n        // }\n        break;\n      case CALLRESULT_MESSAGE:\n        // response\n        debug(`>> ${this.url}: ${message}`);\n\n        const request = this.requests[messageId];\n        if (!request) {\n          throw new Error(`Response for unknown message ${messageId} @ ${this.url} ${message}`);\n        }\n        if (!Array.isArray(request) || request.length <= 0){\n          debug(request);\n          throw new Error(`Response for unknown message ${messageId} @ ${this.url} ${message}. The callback array is invalid`);\n        }\n        const [responseCallback] = request;\n        if (!responseCallback) {\n          throw new Error(`Response for unknown message ${messageId} @ ${this.url} ${message}`);\n        }\n        delete this.requests[messageId];\n\n        responseCallback(commandNameOrPayload);\n        break;\n      case CALLERROR_MESSAGE:\n        // error response\n        debug(`>> ${this.url}: ${message}`);\n\n        if (!this.requests[messageId]) {\n          throw new Error(`Response for unknown message ${messageId} @ ${this.url} ${message}`);\n        }\n        const [, rejectCallback] = this.requests[messageId];\n        delete this.requests[messageId];\n\n        rejectCallback(new OCPPError(commandNameOrPayload, commandPayload, errorDetails));\n        break;\n      default:\n        throw new Error(`Wrong message type ${messageType} @ ${this.url}`);\n    }\n  }\n\n  send (command, messageType = CALL_MESSAGE) {\n    return this.sendMessage(uuid(), command, messageType);\n  }\n\n  sendError (messageId, err) {\n    debug(`Error: ${err.message}`);\n\n    const error = err instanceof OCPPError ? err : new OCPPError(ERROR_INTERNALERROR, err.message);\n\n    return this.sendMessage(messageId, error, CALLERROR_MESSAGE);\n  }\n\n  sendMessage (messageId, command, messageType = CALLRESULT_MESSAGE) {\n    const socket = this.socket;\n    const self = this;\n    const commandValues = getObjectValues(command);\n\n    return new Promise((resolve, reject) => {\n      let messageToSend;\n\n      switch (messageType) {\n        case CALL_MESSAGE:\n          this.requests[messageId] = [onResponse, onRejectResponse];\n          const commandName = command.getCommandName();\n\n          messageToSend = JSON.stringify([messageType, messageId, commandName, commandValues]);\n          break;\n        case CALLRESULT_MESSAGE:\n          messageToSend = JSON.stringify([messageType, messageId, commandValues]);\n          break;\n        case CALLERROR_MESSAGE:\n          const { code, message, details } = command;\n          messageToSend = JSON.stringify([messageType, messageId, code, message, details]);\n          break;\n      }\n\n      debug(`<< ${messageToSend}`);\n      if (socket.readyState === Websocket.OPEN) {\n        socket.send(messageToSend);\n      } else {\n        return onRejectResponse(`Socket closed ${messageId}`);\n      }\n      if (messageType !== CALL_MESSAGE) {\n        resolve();\n      } else {\n        setTimeout(() => onRejectResponse(`Timeout for message ${messageId}`), SOCKET_TIMEOUT);\n      }\n\n      function onResponse (payload) {\n        const response = command.createResponse(payload);\n\n        return resolve(response);\n      }\n      function onRejectResponse(reason) {\n        self.requests[messageId] = [() => {}];\n        const error = reason instanceof OCPPError ? reason : new Error(reason);\n        reject(error);\n      }\n    });\n  }\n\n  onRequest (request) {\n\n  }\n}\n"]}